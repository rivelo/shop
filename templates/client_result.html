<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Виписка по клієнту: {{client_name.name}}</title>

<head>
{#	<link rel="stylesheet" href="/media/css/table.css"> #}  
{#	<link rel="stylesheet" href="/media/jquery-ui.min.css"> #}
<script src="/media/jquery.jeditable.mini.js" type="text/javascript" charset="utf-8"></script>
{#	<script src="/media/jquery-ui.min.js"></script> #}	

</head>

{% load poll_extras %}


<style type="text/css">

{% comment %}

table#balance a{
	color: black;
}

.tooltip-inner {
  background-color: #73AD21 !important;
  color: #color ;
/*  font-size: 20px; */
  width: 500px;
  
}

.price_error {
	border: 5px solid red !important;
}

.bs-tooltip-top .arrow::before, .bs-tooltip-auto[x-placement^="top"] .arrow::before {
  border-top-color: #73AD21 !important;
}

.bs-tooltip-right .arrow::before, .bs-tooltip-auto[x-placement^="right"] .arrow::before {
  border-right-color: #73AD21 !important;
}


.bs-tooltip-bottom .arrow::before, .bs-tooltip-auto[x-placement^="bottom"] .arrow::before {
  border-bottom-color: #73AD21 !important;
}


.bs-tooltip-left .arrow::before, .bs-tooltip-auto[x-placement^="left"] .arrow::before {
  border-left-color: #73AD21 !important;
}
 
.tooltip.warning .tooltip-inner          { background-color:    #ec971f; }
.tooltip.warning.top > .tooltip-arrow    { border-top-color:    #ec971f; }
.tooltip.warning.right > .tooltip-arrow  { border-right-color:  #ec971f; }
.tooltip.warning.bottom > .tooltip-arrow { border-bottom-color: #ec971f; }
.tooltip.warning.left > .tooltip-arrow   { border-left-color:   #ec971f; } 


a.edit_row_user > i {
	color: green;
}

a.delete_row_user > i{
	color: green;
}

a.edit_row_user :HOVER {
	color: red;
}

a.delete_row_user :HOVER{
	color: red;
}

{% endcomment %}

#tabs .ui-tabs-active {
    background: #5ba63c;
	border: #FFFFFF;
	font-weight: bold;
}
    
</style>



    
<script language="JavaScript">

$(document).ready(function() {

//	$('[data-toggle="tooltip"]').tooltip();
//	$('[data-toggle="tooltip"]').show();

	
	$("#dialog").hide();
	$("#dialog_r").hide();
	$("#dialog_msg").hide();
	$("#dialog_ajax_load").hide();
	$("#dialog_return").hide();
	
	$(".profit").hide();
	
  	$( "#img_bike" ).click(function() {
  		$( "#dialog" ).dialog();
	});
	
	$( "#img_msg" ).click(function() {
  		$( "#dialog_msg" ).dialog({
  		resizable: false,
      	modal: true,
  		width: 380,
  		height:"auto",
      	buttons: {
        "Додати": function() {
        	if (!$("#msg_text").length) { 
        	$( this ).append('<textarea type="text" id="msg_text" name="mytext[]" rows="10" cols="40"> </textarea>');
        	$( this ).append('<input id="msg_button" type="button" class="ok_button" name="mytext[]" width="350" value="Відправити">');
        	
        	$(".ok_button").on('click', function(){
				$.ajax({
                type: "POST",
                url: "/clientmessage/add/",
                data: {client:  {{client_name.id}}, msg: $("#msg_text").val() },
                dataType: "json",
                success:function(data){
                	//$( "#dialog_msg" ).dialog("close");
                	$("#img_msg").css("opacity", 1);
                //	$("#dialog_msg p:last").after("<p><b>Message: </b> <br>"+ $('#msg_text').val() +"</p>");
                	$("#dialog_msg").after("<p><b>Message: </b> <br>"+ $('#msg_text').val() +"</p>");
                	$("#msg_text").remove();
                	$("#msg_button").remove();
                },
                error:function(data){
                    alert("При отправке возникли проблемы" + data);
                }
            	});
            console.log("Натиснуто ОК" + $("#msg_text").val()); 
            })
        	}
        	//$( this ).dialog( "close" );
        },
        "Відмінити": function() {
        	$( this ).dialog( "close" );	
        	$("#msg_text").remove();
            $("#msg_button").remove();
        },
        
        }  		
  		});
	});

	
	//$('#img_repair').css("opacity", 1);

{% if request.user|has_group:"admin" %}
$("#show_profit").click(function(){
	$(".profit").toggle();
});
{% endif %}
	

$('.cred_price').each(function() {
	$(this).editable('/clientcredits/set/', {
		 loadurl : '/cashtype/list/',
		 //loaddata : {sel: $(this).attr('tcash_id')},
		 loaddata : function(value, settings) {
		   console.log("load this [tcash_id]= " + $(this).attr('tcash_id'));
	       return {sel: $(this).attr('tcash_id')};
	   	 },
	     loadtype: 'POST',
	     submitdata : function() {
	      	return {id : $(this).attr('id_cred')};
	     },
	     type : 'select',
	     event : 'dblclick',
	     style : 'inherit',
	     callback : function(value, settings) {
	         var obj = jQuery.parseJSON(value);
	         $(this).attr("tcash_id", obj[0]["cash_type__id"])
	         str = '<abbr title="'+ obj[0]["cash_type__name"] +'">'+$(this).attr("value")+'</abbr>';
	         $(this).html(str);
	         sel = obj[0]["cash_type__id"];
	     },
	     tooltip   : 'Натисніть для редагування...',
	     submit : 'OK'
	});
	});


}); // end Ready


function res() {
var sum=0;
	$('.chk_inv').each(function() {
	if(this.checked){
//		console.log("THIS = "+ this.value);
		sum = sum + parseFloat(this.value);
		}
	});
document.getElementById('for_pay').innerHTML = sum + " грн.";
document.getElementById('debet').innerHTML = ( parseFloat(document.getElementById('for_pay').innerHTML) + parseFloat(document.getElementById('workshop_pay').innerHTML) ).toFixed(2);
//document.getElementById('row_count').innerHTML = "Row = " + document.getElementById("product").rows.length;
}
    

function resWorkshop()
{
var p=0;
var All=document.forms['formWorkshopSum'];
for(var i = 0; i < All.elements.length; ++i) {
	if(All.elements[i].checked){
	p+=parseFloat(All.elements[i].value);
	}
	document.getElementById('workshop_pay').innerHTML = p.toFixed(2)+" грн.";
	document.getElementById('debet').innerHTML = ( parseFloat(document.getElementById('for_pay').innerHTML) + parseFloat(document.getElementById('workshop_pay').innerHTML) ).toFixed(2);
}
}




$(function() {
    $( "#tabs" ).tabs({
      beforeLoad: function( event, ui ) {
        //ui.jqXHR.error(function() {
            ui.panel.html(       "Couldn't load this tab. We'll try to fix this as soon as possible. " +           "If this wouldn't be a demo." );
       },
       show: function( e,ui ){
           $( ui.panel ).html('<p>Loading...</p>');
       }
      });
{# }}); #}

    $("#all_cred").click(function(){
            var Id = {{client_name.id}};
            $.ajax({
            	beforeSend: function() {$( "#dialog_ajax_load" ).dialog({modal: true});},
                type: "POST",
                url: "/client_history/cred/",
                data: { clientId: Id },
                dataType: "json",
                success:function(msg){
                	$("#balance .tr_cred").empty(); 
                	$("#1month_cred").attr("cred_day", 0);
                	$("#1month_cred").hide();
                	$.each(msg,function(index,item){
//                		var tdate = item.fields.date.split(" ")[0].replace("-", "/").replace("-", "/");
//                		var fcol = '<abbr title="' + item.fields.date.split(" ")[1] + ' - [user]">' + tdate + '</abbr>';
//                		var cdesc = item.fields.description + " <a href='/clientcredits/delete/" + item.pk + "'>delete</a>";
//                		var price = '<td class="cred_price" tcash_id="'+item.fields.cash_type+'" id_cred="' + item.pk + '" value="'+ item.fields.price+'"><abbr title="' + item.fields.cash_type.name + '">' + item.fields.price + '</abbr>';
//                	    $('.in_cred').after('<tr class="tr_cred"><td>'+ fcol +'</td><td>'+ cdesc +'</td>' + price +'</tr>');
//						var fcol = '<abbr title="' + item['user__username'] + '">' + item['date'] + '</abbr>';
						var fcol = 'title="' + item['user__username'] + '"' + ' data-toggle="tooltip" data-placement="right">' + item['date'];
						var ed = '<a href="/clientcredits/edit/'+item['id']+'"><i class="material-icons" >edit</i></a>';
						var cdesc = item['description'] + ed + " <a href='/clientcredits/delete/" + item['id'] + "'" + "onclick='return confirm(&#039Видалити борг?&#039)'><i class='material-icons'>delete</i></a>";
//						var price = '<td class="cred_price" tcash_id="'+item['cash_type']+'" id_cred="'+item['id']+'" value="'+item['price']+'"><abbr title="' + item['cash_type__name'] + '">' + item['price'] + '</abbr>';
						var price = '<td class="cred_price" tcash_id="'+item['cash_type']+'" id_cred="'+item['id']+'" value="'+item['price']+'" title="' + item['cash_type__name'] + '"' + 'data-toggle="tooltip" data-placement="right">' + item['price'];
                	    $('.in_cred').after('<tr class="tr_cred"><td '+ fcol +'</td><td>'+ cdesc +'</td>' + price +'</td></tr>');
                    });
                $('[data-toggle="tooltip"]').tooltip();	
				$( "#dialog_ajax_load" ).dialog("close");
				reload_price();
                },
                error:function(){
                    alert("При отправке возникли проблемы");
                }
            });      
		});

//--- Борги клієнтів ---
    $("#all_debt").click(function(){
            var Id = {{client_name.id}};
            $.ajax({
            	beforeSend: function() {$( "#dialog_ajax_load" ).dialog({modal: true});},
                type: "POST",
                url: "/client_history/debt/",
                data: { clientId: Id },
                dataType: "json",
                success:function(msg){
                	$("#balance .tr_debt").empty(); 
                	$("#1month_debt").hide();
                	$.each(msg,function(index,item){
//                		var tdate = item.fields.date.split(" ")[0].replace("-", "/").replace("-", "/");
//                		var fcol = '<abbr title="' + item.fields.date.split(" ")[1] + ' - [user]">' + tdate + '</abbr>';
//                		var cdesc = item.fields.description + " <a href='/clientdebts/delete/" + item.pk + "'>delete</a>";
//                	    $('.in_debt').after('<tr class="tr_debt"><td>'+ fcol +'</td><td>'+ cdesc +'</td><td>' + item.fields.price+'</td></tr>');
						var fcol = 'title="' + item['user__username'] + '" data-toggle="tooltip" data-placement="right">' + item['date'];
						var ed = '<a href="/clientdebts/edit/'+item['id']+'"><i class="material-icons" >edit</i></a>';
						var cdesc = item['description'] + ed + " <a href='/clientdebts/delete/" + item['id'] + "'" + "onclick='return confirm(&#039Видалити борг?&#039)'><i class='material-icons'>delete</i></a>";
						var price = '<td>' + item['price'];
                	    $('.in_debt').after('<tr class="tr_debt"><td '+ fcol +'</td><td>'+ cdesc +'</td>' + price +'</td></tr>');
                	    
                    });
                $('[data-toggle="tooltip"]').tooltip();                	
				$( "#dialog_ajax_load" ).dialog("close");                    
                },
                error:function(){
                    alert("При отправке возникли проблемы");
                }
            });      
		});


	$("#1month_cred").click(function(){
		var Id = {{client_name.id}};
            $.ajax({
                type: "POST",
                url: "/client_history/cred/",
//                data: { client_id: Id, cred_month: $(this).attr("cred_month"), cred_year: $(this).attr("cred_year"), cred_day: $(this).attr("cred_day")},
                data: { clientId: Id, cred_month: $(this).attr("cred_month"), cred_year: $(this).attr("cred_year"), cred_day: $(this).attr("cred_day")},
                dataType: "json",
                success:function(msg){
                	if ($("#1month_cred").attr("cred_day") == 0) {
	                	alert ("Виведено всі проплати клієнта");
                	}
                	var prev_day = parseInt($("#1month_cred").attr("cred_day")) + 30;
                	$("#1month_cred").html("+ " + (prev_day-30) + " днів");
                	$("#1month_cred").attr("cred_day", prev_day);
                	//$("#balance .tr_cred").empty(); 
                	$.each(msg,function(index,item){
						var fcol = '<abbr title="' + item['user__username'] + '">' + item['date'] + '</abbr>';
						var ed = '<a href="/clientcredits/edit/'+item['id']+'">edit</a>';
						var cdesc = item['description'] + ed + " <a href='/clientcredits/delete/" + item['id'] + "'>delete</a>";
						var price = '<td class="cred_price" tcash_id="'+item['cash_type']+'" id_cred="'+item['id']+'" value="'+item['price']+'"><abbr title="' + item['cash_type__name'] + '">' + item['price'] + '</abbr>';
                	    $('.in_cred').after('<tr class="tr_cred"><td>'+ fcol +'</td><td>'+ cdesc +'</td>' + price +'</td></tr>');
                    });
                    reload_price();
                },
                error:function(){
                    alert("При отправке возникли проблемы");
                }
            });      
	});


	$("#1month_debt").click(function(){
		var Id = {{client_name.id}};
            $.ajax({
                type: "POST",
                url: "/client_history/debt/",
                data: { client_id: Id, cred_day: $(this).attr("debt_day")},
                dataType: "json",
                success:function(msg){
                	if ($("#1month_debt").attr("debt_day") == 0) {
                		alert ("Виведено всі борги клієнта");
                	}
                	var prev_day = parseInt($("#1month_debt").attr("debt_day")) + 30;
                	$("#1month_debt").html("+ " + (prev_day-30) + " днів");
                	$("#1month_debt").attr("debt_day", prev_day);
                	//$("#balance .tr_debt").empty(); 
                	$.each(msg,function(index,item){
						var fcol = '<abbr title="' + item['user__username'] + '">' + item['date'] + '</abbr>';
						var ed = '<a href="/clientdebts/edit/'+item['id']+'">edit</a>';
						var cdesc = item['description'] + ed + " <a href='/clientdebts/delete/" + item['id'] + "'>delete</a>";
                	    $('.in_debt').after('<tr class="tr_debt"><td>'+ fcol +'</td><td>'+ cdesc +'</td><td>' + item['price']+'</td></tr>');
                    });
                },
                error:function(){
                    alert("При отправке возникли проблемы");
                }
            });      
	});


	$("#last_invoice").click(function(){
		res();	
		var Id = {{client_name.id}};
            $.ajax({
                type: "POST",
                url: "/client_history/invoice/",
                data: { client_id: Id, day: $(this).attr("day")},
                dataType: "json",
                success:function(msg){
                	var day = parseInt($("#last_invoice").attr("day")) + {{tdelta}};
                	$("#last_invoice").html(">>> + " + (day-{{tdelta}}) + " днів");
                	$("#last_invoice").attr("day", day);

                	//$("#product .tr_inv").empty(); 
                	$.each(msg,function(index,item){
                	inp = '<input type="checkbox" class="chk_inv" value="'+item['sum']+'" onclick="res()" name="checkbox_' +item['id']+ '"/>';
                	    $('#th_inv').after('<tr class="tr_inv"><td>'+ item['date'] +'</td><td>['+ item['catalog__ids'] +'] - '+ item['catalog__name'] +'</td><td>'+ item['count'] +'</td>'+'<td>' + item['price']+'</td>'+'<td>'+item['sum']+'</td>'+'<td>'+item['pay']+'<td>'+item['currency__name']+'<td align="center">'+inp+'</td></tr>');
                    });
                },
                error:function(){
                    alert("При отправке возникли проблемы");
                }
            });      
	});


$("#ticket_tab").on("click", function() {
	$("#tabs-3").append($("#t_workticket"));
});

$('.bike_serv').editable('/bicycle/sale/service/', {
     data   : " {'1':'Пройдено','0':'Не пройдено'}",
     submitdata : function() {
      	return {id : $(this).attr('id_bike')};
    	 },
     type   : 'select',
//     tooltip   : 'Натисніть для редагування...',
     submit : 'OK'
});




	$('#selectall').click(function(event) {  //on click 
        if(this.checked) { // check select status
            $('.chk_inv').each(function() { //loop through each checkbox
                this.checked = true;  //select all checkboxes with class "checkbox1"
                res();               
            });
        }else{
            $('.chk_inv').each(function() { //loop through each checkbox
                this.checked = false; //deselect all checkboxes with class "checkbox1"    
                res();                   
            });         
        }
    });

      
});




function reload_price() {

$('.cred_price').each(function() {
$(this).editable('/clientcredits/set/', {
	 loadurl : '/cashtype/list/',
	 loaddata : function(value, settings) {
	   console.log("load this [tcash_id]= " + $(this).attr('tcash_id'));
       return {sel: $(this).attr('tcash_id')};
   	 },
     loadtype: 'POST',
     submitdata : function() {
      	return {id : $(this).attr('id_cred')};
    	 },
     type   : 'select',
     event: 'dblclick',
     style   : 'inherit',
     callback : function(value, settings) {
         var obj = jQuery.parseJSON(value);
         $(this).attr("tcash_id", obj[0]["cash_type__id"])
         str = '<abbr title="'+ obj[0]["cash_type__name"] +'">'+$(this).attr("value")+'</abbr>';
         $(this).html(str);
         sel = obj[0]["cash_type__id"];
     },     
     tooltip   : 'Натисніть для редагування...',
     submit : 'OK'
});
});
}




{% comment %}

$(document).ready(function() {

	
	
	//	$('div.read').on("click", function(){
	//$("body").on("click", "div.read", function(){	
	
	$("div").on("click", ".read", function(){
		console.log('standart');
		  $.ajax({
            	beforeSend: function() {$( "#dialog_ajax_load" ).dialog({modal: true});},
                type: "POST",
                url: "/clientmessage/set/",
                data: { msg_id: $(this).attr("msg_id") },
                dataType: "json",
                success:function(msg){
			    	if ($("div").is(".read")==false) {
		 				$("#img_msg").css('opacity', '0.2');
					}
				$( "#dialog_ajax_load" ).dialog("close");
                },
                error:function(){
                    alert("При отправке возникли проблемы");
                }
            }); 
    	$(this).removeClass('read').addClass('standart');
    	$(this).attr("data-title", "Клікніть для зміни статусу. Статус: Доставлено")
	});

	$("div").on("click", ".standart", function(){
		console.log('read');
		  $.ajax({
            	beforeSend: function() {$( "#dialog_ajax_load" ).dialog({modal: true});},
                type: "POST",
                url: "/clientmessage/set/",
                data: { msg_id: $(this).attr("msg_id") },
                dataType: "json",
                success:function(msg){
             		if ($("div").is(".read")) {
						$("#img_msg").css('opacity', '1');
					};    	
					$( "#dialog_ajax_load" ).dialog("close");
                },
                error:function(){
                    alert("При отправке возникли проблемы");
                }
            });
    	$(this).removeClass('standart').addClass('read');
    	$(this).attr("data-title", "Клікніть для зміни статусу. Статус: В черзі")
	});    
 
	
	
$("body").on('click', '#email_send', function() {
//showbox(function(){
{#	{% if request.user|has_group:"admin" %} - {{client_name.id}} {% endif %} #}
if (confirm('Ви впевненні що хочете відправити лист на пошту {{client_name.email}}')) {
	$.ajax("/client/{{client_name.id}}/sendcard/", {
    	type: 'POST',
    	data: {
      		status: 'email', //'rivelo@ymail.com',
    	},
		success: function(msg){
					alert(msg);
        },
  	})	
}
}); 



$( "#dialog_return" ).dialog({
	modal: true,
	closeOnEscape: true,
	autoOpen: false,
	width: 'auto',
	height: 'auto',
	maxWidth: 500,
	open: function( event, ui ) {
		$('.context-menu').remove(); //видалення меню
		$("#sp_count").spinner({
		min: 1,
		max: $("#sp_count").attr('max'),
		change: function( event, ui ) {
			calc_sum();
		},
		stop: function( event, ui ) {
			//var dsum = $("#sp_count").val() * $("#dialog_return").attr("price");  
			//$("#print_sum").html("Сума: " + dsum);
			calc_sum();
		}
		});
		
	},
    buttons: {
    "Створити": function() {
    if ($("#msg_return").val() != "") {
    var cash = true;
	if ($("#sp_cash").is(':checked')) {
		cash = true;
	}
	else {
		cash = false;
	}

	$.ajax({
       type: "POST",
       	url: "/client/invoice/return/"+$('#dialog_return').attr('id_target')+"/add/",
       	data: {msg: $("#msg_return").val(), count: $("#sp_count").val(), cash: cash},
       	dataType: "text",
       success:function(msg){
        var td_count = $("tr[ci_id ='"+$('#dialog_return').attr('id_target')+"'] td.tcount"); 
        var td_sum = $("tr[ci_id ='"+$('#dialog_return').attr('id_target')+"'] td.tsum");
        var td_pay = $("tr[ci_id ='"+$('#dialog_return').attr('id_target')+"'] td.tpay");
        var rcount = td_count.html() - $("#sp_count").val();
        td_sum.html(td_sum.html() / td_count.html() * rcount);
        td_pay.html(td_sum.html());
        td_count.html(rcount);
        $("tr[ci_id ='"+$('#dialog_return').attr('id_target')+"']").css("background-color","#99FF33");
       	if (td_count.html() == 0) { 
       		$("tr[ci_id ='"+$('#dialog_return').attr('id_target')+"']").hide();
       	}
      	
       },
       error:function(){
         alert("При отправке возникли проблемы");
       }
    });
                
      	$( this ).dialog( "close" );
	}
	else {
	alert("Введіть причину обміну/повернення");
	}
		
    },
    "Відмінити": function() {
       	$( this ).dialog( "close" );	
    },
       
    }
});

$('.edit_workstatus').editable('/workticket/edit/', { 
     loadurl : '/workstatus/view/',
     type   : 'select',
     submit : 'OK',
     event: 'click', //'dblclick',
     submitdata : function() {
      	 	return {id_w : $(this).attr('id_workticket')};
     },
     callback : function(value, settings) {
       switch(value) {
		case 'Прийнято':
         $(this).closest("tr").attr('BGCOLOR', '#CCFF99');
         $('#img_repair').css("opacity", 1);
         break;
		case 'Ремонтується':
         $(this).closest("tr").attr('BGCOLOR', '#FFFF99');
		 break;
		case 'Виконано':
		 $(this).closest("tr").attr('BGCOLOR', '#FFFFFF');
         $('#img_repair').css("opacity", 0.2);
		 break;
		case 'Виконано невидано':
         $('#img_repair').css("opacity", 0.2);
		 break;
		default :
         $(this).closest("tr").attr('BGCOLOR', '#FFFFFF');
       }
     }
 });

{% endcomment %}




{# }}); #}

function show_ret(ciid, item) {
	//iid = $(this).attr("tvalue");
	iid = ciid
	console.log("Catalog = " + $(item).parents('tr').find('td.cat_name > div > div.p-2').html()) // + $(item).parents('tr').find('td.cat_name').html())// > td.cat_name').html() );
	console.log("this = " + item)
	$("#dialog_return").attr("id_target", iid);
	$("#dialog_return").dialog("open");
	//$("ui-id-2").attr("html", "New title");
	//document.getElementById("ui-id-2").innerHTML = "Повернення: " + ""
	$("#ui-id-6").html("Повернення: " + $(item).parents('tr').find('td.cat_name > div > div.p-2').html().substr(0, 35));
}

$('.phone').editable('/workticket/edit/', { 
    loadurl : '/phonestatus/view/',
    type   : 'select',
    submit : 'OK',
    submitdata : function() {
     	 	return {id_wp : $(this).attr('id_workticket')};
    },
    callback : function(value, settings) {
{% comment %}
    	switch(value) {
		case 'Прийнято':
        $(this).closest("tr").attr('class', 'w_true');
        break;
		case 'Ремонтується':
        $(this).closest("tr").attr('class', 'w_working');
		 break;
		case 'Виконано':
        $(this).closest("tr").attr('class', 'w_done_done');
		 break;
		case 'Виконано невидано':
        $(this).closest("tr").attr('class', 'w_done');
		 break;
		default :
        $(this).closest("tr").attr('class', 'w_true');
      }
{% endcomment %}    	
    }
}); 

</script>


<body onLoad="res(); resWorkshop()">

{# DIALOG start #}

{% if email == False %}

<div id="dialog_ajax_load" title="Завантаження">
<h2>Зачекайте, триває завантаження ... </h2>
</div>

<!-- dialog for client message -->
<div id="dialog_msg" title="Повідомлення" >
{% for msg in messages %}
{% if msg.status  %}
<div id="msg_{{msg.id}}" class="standart" msg_id="{{msg.id}}" data-title="Клікніть для зміни статусу. Статус: {{msg.status|yesno:'Доставлено,В черзі'}}">
<p style="font-style: normal;"><b>Message [{{msg.date}}]: </b> <br> {{msg.msg}} </p>
</div>
{% else %}
<div id="msg_{{msg.id}}" class="read" msg_id="{{msg.id}}" data-title="Клікніть для зміни статусу. Статус: {{msg.status|yesno:'Доставлено,В черзі'}}">
<p style="font-style: normal;"><b>Message [{{msg.date}}]: </b> <br> {{msg.msg}} </p>
</div>
{% endif %}
{% endfor %}  
</div>	


<div id="dialog_return" title="Повернення/Обмін" id_target="">
<label>Введіть причину відмови/повернення</label><br>
<textarea  name="dreturn" id="msg_return" value="" wrap="soft" cols="42" rows="7"></textarea>
<br>
<label>Введіть кількість</label>
<input id="sp_count" value="1" max="5">
<br>
<label>Готівка</label>
<input type="checkbox" id="sp_cash" >
<label id="print_sum" class="ressum">Сума:</label>
</div>

<!-- repair bike  
<img style="display: none;" id="img_repair" src="http://thumb10.shutterstock.com/thumb_small/295516/103760093/stock-photo-bicycle-repair-sign-on-a-white-background-part-of-a-series-103760093.jpg" height="64px" >
-->


{% endif %}



<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Заявки на ремонт</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

<table id="t_workticket" class = "table table-bordered table-hover table-condensed iTable" width="100%">
  <script>
	$( "#img_repair" ).click(function() {
		window.location.href = "/workticket/add/client/"+ {{client_name.id}} +"/";	
//    	console.log("/workticket/add/client/"+ {{client_name.id}} +"/");
  	});
  </script>


{% for ticket in workshopTicket  %}
{% if ticket.status__name == 'Прийнято' %}
  <tr bgcolor="#CCFF99" > 
  <script>
  $( "#img_repair" ).unbind(); 
  $( "#img_repair" ).click(function() {
  $("#dialog_r").append($("#t_workticket"));
  $( "#dialog_r" ).dialog({
      buttons: {
        "Створити": function() {
        	$( this ).dialog( "close" );
        	window.location.href = "/workticket/add/client/"+ {{client_name.id}} +"/";	
        },
        "Відмінити": function() {
        	$( this ).dialog( "close" );	
        },
        
        }
  });
  });

//  $('#img_repair').show();
  $('#img_repair').css("opacity", 1);

  </script>
  
{% else %}
  <tr bgcolor="#FFFFFF">
{% endif %}  
  <td title="Майстерня: {{ticket.shop__name}}" data-toggle="tooltip" data-placement="top">{{ticket.date}}</td>
  <td title="Створив заявку: {{ticket.user__username}}" data-toggle="tooltip" data-placement="top">
  {% if ticket.bicycle %}
  Велосипед: {{ticket.bicycle}}.
  {% elif bike_part_type %}  
  Запчастина: {{bike_part_type}}. 
  {% endif %} 
   {{ticket.description}}. 
  <a style="text-align: right;" href="{% url 'workticket_edit' ticket.id %}" title="Редагувати заявку"  data-toggle="tooltip" data-placement="right"><i class="material-icons">edit</i></a>
  </td>
  <td class="edit_workstatus" id_workticket={{ticket.id}}>
  {{ticket.status__name}}
  </td>
<td class="phone" id_workticket="{{ticket.id}}">       
	{{ticket.phone_status__name}}
</td>
	{% if ticket.phone_user.username %}
		<td title={{ticket.phone_user__username}} align="center">
	{% else %}
		<td align="center" title="{{ticket.phone_user__username}}">
	{% endif %}       
	{{ticket.phone_date|date:'d-m-Y H:i'}} 
	</td>
	
  </tr>
{% endfor %}



</table>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>




<div id="dialog" title="Придбані велосипеди">
{% for bike in b_bike %}
<p><b>Велосипед {{bike.model__model__brand__name}} {{bike.model__model__model}} {{bike.model__size__name}}</b> S/N: [{{bike.model__serial_number}}] <br> Дата продажу: {{bike.date}} 
<br> Сервіс: <b class="bike_serv" id_bike={{bike.id}}>{{bike.service|yesno:"Пройдено,Не пройдено"}}</b></p>
{% endfor %}  
</div>	

{# DIALOG END #}






{# HTML Main #}
<div class="container-fluid">

<div class="row">
<div class="col-xs-12 col-sm-9 col-md-9 col-lg-9">
    <h1>
    <span class="badge badge-secondary" title="{{client_name.phone|phone2Str}}" data-toggle="tooltip" data-placement="bottom" data-html="true" >Виписка по клієнту:</span>
    <span  data-html="true" title="<font size='1'>Телефон: </font> <font size='4'>{{client_name.phone|phone2Str}}</font> <br> <font size='2'> E-mail: {{client_name.email}}</font>" data-toggle="tooltip" data-placement="bottom">
    <a id="client_fio" href=/client/edit/{{client_name.id}}> {{client_name.name}} ({{client_name.forumname}}) </a>
    </span>
    </h1>
</div>


<div class="col">
<img style="display: True; opacity: 0.2" id="img_repair" src="/media/images/bicycle-repair.jpg" height="56px" title="Майстерня" data-toggle="modal" data-target="#exampleModalCenter">
{% if status_msg %}
<img style="display: True; opacity: 1" id="img_msg" src="/media/images/Message-ico.png" height="56px" title="Нові повідомлення" data-toggle="tooltip" data-placement="bottom">
{% else %}
<img style="display: True; opacity: 0.2" id="img_msg" src="/media/images/Message-ico.png" height="56px" title="Нові повідомлення: ВІДСУТНІ" data-toggle="tooltip" data-placement="bottom">
{% endif %}
{% if b_bike %}
<img style="display: True;" id="img_bike" src="/media/images/green-bicycle_ico.png" height="50px" title="Придбані велосипеди" data-toggle="tooltip" data-placement="bottom">
{% endif %}

 <img style="display: None;" id="img_attention" src="/media/images/system-attention-icon.png" height="50px" title="Непроведені операції/роботи"> {# data-toggle="tooltip" data-placement="bottom"> #}
	
{% if status_order %}
<img style="display: True;" id="img_order" src="/media/images/components_order.png" height="50px" title="Замовлення компонентів">
{% else %}
<img style="display: None;" id="img_order" src="/media/images/components_order.png" height="50px" title="Замовлення компонентів">
{% endif %}

{% if status_rent %}
<img style="display: True;" id="img_rent" src="/media/images/test_icon.png" height="50px" title="Тест сидінь">
{% else %}
<img style="display: None;" id="img_rent" src="/media/images/test_icon.png" height="50px" title="Тест сидінь">
{% endif %}

<span id="email_send"><img src="/media/images/green-mail-send-icon_48.png" width="56px" height="56px" title="Відправити картку клієнта на Email" data-toggle="tooltip" data-placement="left"></span> 
</div>
  
</div>


<div class="row">
<div class="col">
	 <h1 style="color:red;" > 
	 <span class="badge badge-danger">Cума:  {{clients|floatformat:2}} грн.</span>
	 </h1>	
</div>	
</div>


{# DEB/CRED main Table #}	
<div class="row">
<div class="col-sm-12 col-xs-12 col-md-12 col-lg-9">	
<table id="balance" class="table table-bordered table-sm">
<thead class="thead-dark">
	<tr>
	<th>Дата</th>
	<th>Опис</th>
	<th>Сума (грн)</th>
	</tr>
</thead>
<tbody>	
	<tr BGCOLOR="#29AE48"  class="in_cred">
	<td>
	Оплати
	</td>
	<td>
	<h4>
	<a href="/clientcredits/add/{{client_name.id}}" class="badge badge-secondary">Створити нову проплату <span class="badge badge-light"><i class="material-icons">add</i></span></a>  
	{% if perms.accounting.delete_clientcredits %}
	 <a href="/clientcredits/{{client_name.id}}/delete/all" onclick="return confirm('Видалити проплати?')" class="badge badge-warning">Видалити всі проплати</a> 
	{% endif %}
	{% if user.is_authenticated %}		
	 <a id="all_cred" href="javascript:" class="badge badge-info">Показати всі проплати</a>
	 <a id="1month_cred" class="badge badge-pill badge-dark text-white" href="javascript:" cred_month="12" cred_year="2014" cred_day="60" data-toggle="tooltip" data-placement="right" title="Показати оплати за минулі 30 днів">+ 30 днів</a>	 
	{% endif %}		
	 </h4>
	</td>
	<td>
	</td>
	</tr>
	{% for credit in credit_list %}
	<tr class="tr_cred">
	<td title='{{credit.date|time:"H:i"}} - [{{credit.user.username}}]'  data-toggle="tooltip" data-placement="right">
		
	{{credit.date|date}}
	</abbr>
	</td>
	<td>
	<div class="d-flex">
  <div class="p-2">	{{credit.description}}</div>
  <div class="ml-auto p-2">
	{% if perms.accounting.delete_clientcredits %}
	<a href="/clientcredits/edit/{{ credit.id }}" class="edit_row_user"><i class="material-icons">edit</i></a>
	<a href="/clientcredits/delete/{{ credit.id }}" onclick="return confirm('Видалити запис?')" class="delete_row_user"><i class="material-icons">delete</i></a>	
	{% endif %}
  </div>
	</div>
	</td>
	{% if credit.cash_type.name == "Помилкова"  %}
	<td class="cred_price text-right price_error" tcash_id="{{credit.cash_type.id}}" id_cred={{credit.id}} value="{{credit.price}}" title="{{credit.cash_type.name}}"  data-toggle="tooltip" data-placement="right">
	{% else %}
	<td class="cred_price text-right" tcash_id="{{credit.cash_type.id}}" id_cred={{credit.id}} value="{{credit.price}}" title="{{credit.cash_type.name}}"  data-toggle="tooltip" data-placement="right">
	{% endif %}
	
	{{credit.price}}
	</td>
	{% endfor %}
	</tr>

	<tr BGCOLOR="#F11111" class="in_debt">
	<td>
	Борги
	</td>
	<td>
	<h4>
	<a href=/clientdebts/add/{{client_name.id}} class="badge badge-secondary text-white"> Додати борг <span class="badge badge-light"><i class="material-icons">remove</i></span></a>
	{% if perms.accounting.delete_clientcredits %}
	 <a href="/clientdebts/{{client_name.id}}/delete/all" onclick="return confirm('Видалити борг?')" class="badge badge-warning">Видалити всі борги</a>
	{% endif %}
	{% if user.is_authenticated %}	
	 <a id="all_debt" href="javascript:" class="badge badge-info">Показати всю історію боргів</a>  
	<a id="1month_debt" class="badge badge-pill badge-dark text-white" href="javascript:" debt_day=60 data-toggle="tooltip" data-placement="right" title="Показати борги за минулі 30 днів">+ 30 днів</a>
	{% endif %}
	</h4>	
	</td>
	<td  title="Сума непроведенних товарів/послуг"  data-toggle="tooltip" data-placement="right" align="center" >
	<h3><span id="debet" class="badge badge-light"> </span></h3>
	</td>
	</tr>

	{% for debt in debt_list %}
	<tr class="tr_debt">
	<td title='{{debt.date|time:"H:i"}} - [{{debt.user.username}}]'  data-toggle="tooltip" data-placement="right">
	{{debt.date|date}}
	</td>
	<td>
	<div class="d-flex">
  <div class="p-2">{{debt.description}}</div>
  <div class="ml-auto p-2">
	{% if perms.accounting.delete_preorder %}
    <a href="/clientdebts/edit/{{ debt.id }}" class="edit_row_user"><i class="material-icons" >edit</i></a>	
    <a href="/clientdebts/delete/{{ debt.id }}" onclick="return confirm('Видалити запис?')" class="delete_row_user"><i class="material-icons">delete</i></a>
	{% endif %}
  </div>
	</div>
	
	</td>
	<td class="text-right" title="{{debt.cash|yesno:"Каса,Віртуальні"}}" data-toggle="tooltip" data-placement="right" >
	{{debt.price}}
	</td>
	{% endfor %}
	</tr>
</tbody>	
	</table>
</div>
</div>



<div id="tabs">
  <ul>
    <li><a href="#tabs-1">Товари</a></li>
{% if email == False %}
    <li><a href="/client/{{client_name.id}}/invoice/lookup/">Проданий товар</a></li>
    <li id="ticket_tab"><a href="#tabs-3">Заявки</a></li>
{% endif %}    
    <li><a href="#tabs-2">Майстерня</a></li>
  </ul>
  <div id="tabs-1">
{# Проданий Товар #}	
<form action="/payform/" method="post" name="formSum">
	<br>
	<table id="product" class="table table-bordered table-hover table-condensed">
	<tr id="th_inv">
	<th>Дата</th>
	<th>Товар <a href="javascript:" id="last_invoice" day="{{ tdelta|add:tdelta }}">  >>> [+ {{tdelta}} днів] </a></th>
	<th>Кількість</th>
	<th>Прайс</th>
	<th id="show_profit">Сума</th>
	<th class="profit">Profit</th>
	<th>Оплата</th>
	<th>Валюта</th>
	<th>Оплата</th>
	</tr>
	
	{% for inv in invoice %}
	<tr class="tr_inv" ci_id="{{inv.id}}" count="{{inv.count}}" cat_id={{inv.catalog.pk}} cat_name="{{inv.catalog}}">
	<td title="{{inv.user}} - {{inv.date|time:"H:i"}}" data-toggle="tooltip" data-placement="top">
	<a href="{% url 'client-invoice-day' inv.date.year inv.date.month inv.date.day%}" >{{inv.date}}</a>
	</td>
	<td class="cat_name">
	<div class="d-flex">
	<div class="p-2">	{{inv.catalog}}</div>
  	<div class="ml-auto p-2">

	{% if inv.pay != inv.sum %}
	<a href="{% url 'client-invoice-edit' inv.pk %}" title="Редагувати" data-toggle="tooltip" data-placement="right"><i class="material-icons" >edit</i></a>
	{% endif %}

	{% if request.user|has_group:"admin" %}
	{% if inv.pay != inv.sum %}
	<a href="{% url 'client-invoice-delete' inv.pk %}" onclick="return confirm('Видалити товар {{inv.catalog}}?')" title="Видалити" data-toggle="tooltip" data-placement="right"><i class="material-icons" >delete</i></a>
	{% endif %}
	{% endif %}
	
	{% if inv.pay == inv.sum %}
	<a href="#" onclick="show_ret(ciid={{inv.id}}, this);return false" title="Обмін/Повернення" data-toggle="tooltip" data-placement="right"><i class="material-icons" >undo</i></a> 
{#	<a href="#" onclick="show_ret();return false" title="Обмін/Повернення" data-toggle="tooltip" data-placement="right"><i class="material-icons" >undo</i></a> #}
	{% if request.user|has_group:"admin" %} <a href="{% url 'client-invoice-edit' inv.pk %}" title="Редагувати" data-toggle="tooltip" data-placement="right"><i class="material-icons" >edit</i></a> {% endif %}
	{% endif %}
	
	</div>
	</div>	
	</td>
	<td>
	{{inv.count}}
	</td>
	<td>
	{{inv.price}}
	</td>
	<td>
	{{inv.sum}}
	</td>
	<td class="profit">
	{% if perms.accounting.add_preorder %} 
	{{inv.get_profit.0|floatformat:"2"}}  
	{% if 0 < inv.get_profit.1 %}
	<h5 style="background-color: #086120; color: white; text-align: center;">
	{{inv.get_profit.1|floatformat:"0"}}
	</h5>
	{% else %}
	<h5 style="background-color: red; color: bisque; text-align: center;">
	{{inv.get_profit.1|floatformat:"0"}}
	</h5>
	{% endif %}
    {% endif %}
	</td>
	
{% ifequal inv.sum inv.pay %}
	<td>
	{{inv.pay}}
	</td>	
	<td>
	{{inv.currency}}
	</td>
	<td align="center">
	<input type="checkbox" id="model{{forloop.counter}}" value="{{inv.sum}}" onclick="res()" class="chk_inv" name="checkbox_{{ inv.id }}"/>
	</td>
{% else %}
	<td BGCOLOR="#FF6600">
	{{inv.pay}}
	</td>	
	<td>
	{{inv.currency}}
	</td>
	<td align="center">
	<input type="checkbox" id="model{{forloop.counter}}" value="{{inv.sum}}" onclick="res()" class="chk_inv" checked name="checkbox_{{ inv.id }}"/>
	</td>
	<script>
			$("#img_attention").show(); 
	</script>
{% endifequal %}
	</tr>
	{% endfor %}
	
	<tr>
	<th id="row_count"></th>
	<th></th>
	<th></th>
	<th>Загальна сума</th>
	<th>{{client_invoice_sum}} грн.</th>
	<th class="profit">Profit</th>
	<th><p><input type="submit" value="Оплата" name="pay"></p>
	<input type="submit" value="E-mail" name="send_check"></th>
	{% if perms.accounting.delete_clientcredits %}
	<th BGCOLOR="#D5FFB4">До оплати<br><input type="checkbox" id="selectall">Виділити всі<br></th>
	{% else %}
	<th BGCOLOR="#D5FFB4">До оплати</th>
	{% endif %}
	<th id="for_pay" BGCOLOR="#D5FFB4">0</th>
	</tr>
	</table>
</form>	


  </div>

<div id="tabs-2">
{# Роботи майстерні #}
<form action="/payform/workshop/" method="post" name="formWorkshopSum" >
<br>
{# border=1 width="100%" style="font-size : 12px; font-family : Arial;" #}
	<table class = "table table-bordered table-hover table-condensed" id="iTable">
	<tr bgcolor="grey">
	<th>Дата</th>
	<th>Робота</th>
	<th>Прайс</th>
	<th>Опис</th>
	<th>Оплата</th>
	</tr>
	
	{% for inv in workshop %}
	<tr>
	<td title="{{inv.date|time:"H:i"}} - {{inv.user}}" data-toggle="tooltip" data-html="true" data-placement="left">
	<a href="{% url 'workshop_day' inv.date.year inv.date.month inv.date.day%}" >{{inv.date}}</a>
	</td>
	<td>
	{{inv.work_type}}
	</td>
{% if inv.pay %}	
	<td>
	{{inv.price}}
	</td>
	<td>
	{{inv.description}}
	</td>	
	<td align="center">
	<input type="checkbox" id="model_workshop{{forloop.counter}}" value="{{inv.price}}" onclick="resWorkshop()" name="checkbox_{{ inv.id }}"/>
	</td>	
{% else %}
	<td BGCOLOR="#FF6600">
	{{inv.price}}
	</td>
	<td>
	{{inv.description}}
	</td>	
	<td align="center">
	<input type="checkbox" id="model_workshop{{forloop.counter}}" value="{{inv.price}}" onclick="resWorkshop()" checked name="checkbox_{{ inv.id }}"/>
	</td>
	<script>
	 $("#img_attention").show(); 
	</script>
{% endif %}
	</tr>
	{% endfor %}
	
	<tr>
	<th></th>
	<th>Загальна сума</th>
	<th>{{client_workshop_sum}} грн.</th>
	<th BGCOLOR="#D5FFB4">
	<p><input type="submit" value="Оплата" name="pay" onClick="return confirm('Провести операцію?')"></p>
	<input type="submit" value="E-mail" name="send_check">	
	</th>
	<th><p>До оплати:</p><p id="workshop_pay" BGCOLOR="#D5FFB4">0<p></th>
	</tr>
	</table>
	
</form>
	</div>

{# Заявки на ремонт #}
{#% if email == False %#}
<div id="tabs-3" onClick='$("#tabs-3").append($("#t_workticket"))'>
</div>
	
</div>

{% comment %}
{% endcomment %}



<h3>
<a class="badge badge-pill badge-secondary" href="/workticket/add/client/{{client_name.id}}/"> 
Створити заявку на ремонт
</a>
<a class="badge badge-pill badge-secondary" href="/workshop/add/client/{{client_name.id}}/" data-toggle="tooltip" data-placement="bottom" data-type="warning" title="Додати клієнту роботу"> 
Додати роботу
</a>
<a class="badge badge-pill badge-secondary" href="/client/search/"> Пошук клієнта </a>
</h3>


{% orm_debug %}
{#% endif %#}
 
 
 </div>
 
 </body>




